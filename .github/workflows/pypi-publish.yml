name: Publish Python Package

on:
  workflow_run:
    workflows:
      - Publish Release Assets
    types:
      - completed

jobs:
  stage-pypi:
    name: Stage PyPI distributions
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    outputs:
      version: ${{ steps.read-manifest.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download release metadata
        uses: actions/download-artifact@v4
        with:
          name: release-metadata
          path: dist/release
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read release version
        id: read-manifest
        shell: bash
        run: |
          set -euo pipefail
          version="$(python3 - <<'PY'
          import json
          from pathlib import Path

          manifest = json.loads(Path("dist/release/manifest.json").read_text(encoding="utf-8"))
          print(manifest["version"])
          PY
          )"

          if [[ -z "${version}" ]]; then
            echo "Failed to read version from dist/release/manifest.json"
            exit 1
          fi

          echo "version=${version}" >> "${GITHUB_OUTPUT}"

      - name: Download vendor artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/vendor-artifacts
          pattern: vendor-*
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Assemble vendor tree
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/vendor

          shopt -s nullglob
          for artifact_dir in dist/vendor-artifacts/vendor-*; do
            target="${artifact_dir##*/vendor-}"
            mkdir -p "dist/vendor/${target}"

            if [[ -d "${artifact_dir}/${target}" ]]; then
              cp -R "${artifact_dir}/${target}/." "dist/vendor/${target}/"
            else
              cp -R "${artifact_dir}/." "dist/vendor/${target}/"
            fi
          done

          find dist/vendor -maxdepth 4 -type f | sort

      - name: Install wheel build dependencies
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip setuptools wheel

      - name: Stage PyPI wheels from release binaries
        shell: bash
        run: |
          set -euo pipefail
          version="${{ steps.read-manifest.outputs.version }}"
          python3 scripts/stage_pypi_packages.py \
            --release-version "${version}" \
            --vendor-src dist/vendor \
            --output-dir dist/pypi

      - name: Stage source distribution
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist/pypi

      - name: Upload PyPI distributions
        uses: actions/upload-artifact@v4
        with:
          name: pypi-dists
          path: dist/pypi/*
          if-no-files-found: error

  publish-pypi:
    name: Publish to PyPI
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    needs: stage-pypi
    environment:
      name: pypi
      url: https://pypi.org/p/xuanwo-xurl
    permissions:
      id-token: write
    steps:
      - name: Download PyPI distributions
        uses: actions/download-artifact@v4
        with:
          name: pypi-dists
          path: dist

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
