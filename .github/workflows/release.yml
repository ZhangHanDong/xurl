name: Publish Release Assets

on:
  push:
    tags:
      - "v*"

jobs:
  validate-tag:
    name: Validate release tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.resolve-version.outputs.version }}
      is_prerelease: ${{ steps.resolve-version.outputs.is_prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve release version
        id: resolve-version
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          if [[ -z "${version}" ]]; then
            echo "Failed to parse version from tag: ${GITHUB_REF_NAME}"
            exit 1
          fi

          is_prerelease="true"
          if [[ "${version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            is_prerelease="false"
          fi

          echo "version=${version}" >> "${GITHUB_OUTPUT}"
          echo "is_prerelease=${is_prerelease}" >> "${GITHUB_OUTPUT}"

      - name: Ensure tag version matches Cargo version
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.resolve-version.outputs.version }}"
          cargo_version="$(awk -F '\"' '$1 ~ /^version = / { print $2; exit }' xurl-cli/Cargo.toml)"

          if [[ -z "${cargo_version}" ]]; then
            echo "Failed to read version from xurl-cli/Cargo.toml"
            exit 1
          fi

          if [[ "${tag}" != "${cargo_version}" ]]; then
            echo "Tag version (${tag}) does not match Cargo version (${cargo_version})."
            exit 1
          fi

  build-native:
    name: Build native binary for ${{ matrix.platform.target }}
    needs: validate-tag
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary: xurl
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            binary: xurl
          - os: macos-15-intel
            target: x86_64-apple-darwin
            binary: xurl
          - os: macos-14
            target: aarch64-apple-darwin
            binary: xurl
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary: xurl.exe
          - os: windows-11-arm
            target: aarch64-pc-windows-msvc
            binary: xurl.exe

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Build release binary
        shell: bash
        run: cargo build --locked --release -p xurl-cli --target ${{ matrix.platform.target }}

      - name: Prepare vendor payload
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "dist/vendor/${{ matrix.platform.target }}/xurl"
          cp "target/${{ matrix.platform.target }}/release/${{ matrix.platform.binary }}" \
             "dist/vendor/${{ matrix.platform.target }}/xurl/${{ matrix.platform.binary }}"

      - name: Package release archive
        shell: bash
        run: |
          set -euo pipefail
          version="${{ needs.validate-tag.outputs.version }}"
          archive_name="xurl-${version}-${{ matrix.platform.target }}.tar.gz"
          mkdir -p dist/release

          tar -czf "dist/release/${archive_name}" \
            -C "target/${{ matrix.platform.target }}/release" \
            "${{ matrix.platform.binary }}"

      - name: Upload release archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.platform.target }}
          path: dist/release/*.tar.gz
          if-no-files-found: error

      - name: Upload vendor artifact
        uses: actions/upload-artifact@v4
        with:
          name: vendor-${{ matrix.platform.target }}
          path: dist/vendor/${{ matrix.platform.target }}
          if-no-files-found: error

  publish-release:
    name: Publish GitHub release assets
    runs-on: ubuntu-latest
    needs:
      - validate-tag
      - build-native
    permissions:
      contents: write
    steps:
      - name: Download release archives
        uses: actions/download-artifact@v4
        with:
          path: dist/release
          pattern: release-*
          merge-multiple: true

      - name: Generate checksums and manifest
        shell: bash
        run: |
          set -euo pipefail
          version="${{ needs.validate-tag.outputs.version }}"
          release_tag="v${version}"

          cd dist/release
          shopt -s nullglob
          archives=(xurl-"${version}"-*.tar.gz)
          if [[ ${#archives[@]} -eq 0 ]]; then
            echo "No release archives found."
            exit 1
          fi

          sha256sum "${archives[@]}" | sort > checksums.txt

          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          version = os.environ["VERSION"]
          release_tag = os.environ["RELEASE_TAG"]
          repo = os.environ["GITHUB_REPOSITORY"]
          checksums_path = Path("checksums.txt")

          artifacts: dict[str, dict[str, str]] = {}
          for line in checksums_path.read_text(encoding="utf-8").splitlines():
              sha256, filename = line.split("  ", maxsplit=1)
              prefix = f"xurl-{version}-"
              suffix = ".tar.gz"
              if not filename.startswith(prefix) or not filename.endswith(suffix):
                  continue
              target = filename[len(prefix) : -len(suffix)]
              artifacts[target] = {
                  "filename": filename,
                  "sha256": sha256,
                  "url": f"https://github.com/{repo}/releases/download/{release_tag}/{filename}",
              }

          if not artifacts:
              raise RuntimeError("No artifacts generated from checksums.txt.")

          manifest = {
              "version": version,
              "release_tag": release_tag,
              "artifacts": artifacts,
          }
          Path("manifest.json").write_text(json.dumps(manifest, indent=2) + "\n", encoding="utf-8")
          PY
        env:
          VERSION: ${{ needs.validate-tag.outputs.version }}
          RELEASE_TAG: v${{ needs.validate-tag.outputs.version }}

      - name: Upload release metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-metadata
          path: |
            dist/release/checksums.txt
            dist/release/manifest.json
          if-no-files-found: error

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate-tag.outputs.version }}
          prerelease: ${{ needs.validate-tag.outputs.is_prerelease == 'true' }}
          files: |
            dist/release/xurl-${{ needs.validate-tag.outputs.version }}-*.tar.gz
            dist/release/checksums.txt
            dist/release/manifest.json
          overwrite_files: true
